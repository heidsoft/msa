<html><head><title>网络7层管理和过滤的领导者</title>
<META 	content="text/html; charset=utf-8" http-equiv=Content-Type>
<LINK 	rel=stylesheet type=text/css href="/ext/resources/css/ext-all.css">
<LINK 	rel=stylesheet type=text/css href="/ext/resources/css/xtheme-default.css">
<link 	href="/Content/IconCls.css" rel="stylesheet" type="text/css" />
<link 	rel="stylesheet" type="text/css" href="/msa/publiccss/css.css" type="text/css">
<link 	rel="stylesheet" type="text/css" href="/msa/publiccss/pubcss.css">
<SCRIPT type=text/javascript  src="/ext/adapter/ext/ext-base.js"></SCRIPT>
<SCRIPT type=text/javascript  src="/ext/ext-all.js"></SCRIPT>
<SCRIPT type=text/javascript  src="/msa/publicjs/pubstyle.js"></SCRIPT>
<script type=text/javascript  src="/msa/publicjs/select_time.js"></script>
<script type=text/javascript  src="/msa/publicjs/exportexcel.js"></script>

<script type="text/javascript">
	Ext.BLANK_IMAGE_URL = '/msa/extjs/resources/images/default/s.gif';
		var xtzystore;
    var pagesize;
    pagesize=100;
  Ext.onReady(function(){
		var hgt=(screen.height)-220;
		Ext.QuickTips.init();
		var detailEl;
		
		var myMask = new Ext.LoadMask(Ext.getBody(),
    {
        msg:"Please wait..."
    });
		myMask.show();
	
		xtzystore=new Ext.data.GroupingStore({
	      url:'/msa/main.xp',
	      baseParams:{Fun:'msaReportJsonStore',reportdir:"exportratesort"},
	      reader: new Ext.data.JsonReader({
	           root:'Results',
	           totalProperty:'totalCount',
	           remoteSort:true,
	           fields: [
		           			{name: 'reportname'},
										{name: 'dates'},
										{name: 'bydate'},
										{name: 'reportdir'},
										{name: 'bfile'},  
										{name: 'reportstate'},
										{name: 'condition'}
					   ]
	      }),
	      sortInfo:{field: 'reportname', direction: 'DESC'},
	      groupField:['bydate']
		});
		xtzystore.load();
	
		HlPagingToolbar = Ext.extend(Ext.PagingToolbar, { 
    displayInfo: true, 
    displayMsg: '显示第 {0} 条到 {1} 条记录，共 {2} 条', 
    emptyMsg: "无记录", 
    initComponent : function(){ 
    							var pageSizeItems = [ 
                     '-','每页', 
                      this.inputItem = new Ext.form.NumberField({ 
									    cls: 'x-tbar-page-number', 
									    allowDecimals: false, 
									    allowNegative: false, 
									    enableKeyEvents: true, 
									    maxValue: 500, 
									    maxText: '每页不允许超过500条', 
									    selectOnFocus: true, 
									    value: this.pageSize, 
									    submitValue: false, 
									    listeners: { 
									        scope: this, 
									        keydown: this.onHlPagingKeyDown, 
									        blur: this.onHlPagingBlur 
									    } 
                     }),'条','-',{
						            icon: '/msa/images/grid.png',
						            enableToggle:true,
						            text: '导出本页数据到Excel',
						            cls: 'x-btn-text-icon details',
						            toggleHandler: function(btn, pressed){
						                downloadViewDataActive(xtzygrid);
						            }
						        },'-',{
						            icon: '/msa/images/drop-yes.gif',
						            enableToggle:true,
						            text: '开始分析',
						            cls: 'x-btn-text-icon details',
						            toggleHandler: function(btn, pressed){								          
										         		document.getElementById("south").style.display="";		
							      					var mywin = new Ext.Window({
																			title: '选择条件',		
																			closeAction: 'hide',
																			width:350,
																			height:250,
																			resizable:false,
																			plain:true,
																			autoScroll:true,
																			contentEl:'south',
																			bodyStyle:'padding:5px;',
																			buttons: [{
														            text: '生成报告',
														            tooltip:'根据你的选择，将生成出口速率分布相应报告', //悬停提示  
																        tooltipType:'qtip',  
																				handler  : function(){	
																									var sdate = Ext.getDom('sdate').value;
																									var edate = Ext.getDom('edate').value;
																									var groupby=Ext.getDom('groupby').value;
																									var rname = Ext.getDom('rname').value;
																									Ext.MessageBox.show({
																							           msg: '报告生成中，这需要一段时间，您可以继续等待或者稍后察看结果',
																							           progressText: 'apply...',
																							           width:300,
																							           wait:true,
																							           waitConfig: {interval:500},
																							           icon:'ext-mb-download'
																							    });
																								
																									Ext.Ajax.request({
																										method : 'POST',
																										url:'/msa/main.xp',
																										success: function(response,options){
																											var txt=response.responseText;
																											if(txt.substring(0,1)=="1"){	   
																												Ext.MessageBox.hide();
																												Ext.MessageBox.alert("提示信息","操作成功");
																											}else{
																												Ext.MessageBox.alert("提示信息","操作失败");
																											}
																											xtzystore.load();
																										},
																										failure: function(response,options){
																											Ext.MessageBox.alert("提示信息","操作失败");
																										},
																										params:{Fun:'msasortreport',
																											sdate:sdate,
																											edate:edate,
																											groupby:groupby,
																											name:rname,
																											gtype:-1,
																											type:4                                 
																										}	
																									});
																									mywin.hide();
																		  	}
																		  	}]	
															});
		
										          mywin.show();
		
						        }},'-',{
							            icon: '/msa/images/drop-yes.gif',
							            enableToggle:true,
							            text: '删除选中报告',
							            cls: 'x-btn-text-icon details',
							            toggleHandler: function(btn, pressed){								          
																	var selModel = xtzygrid.getSelectionModel();
									                if(selModel.hasSelection()) {
									                    Ext.Msg.confirm("警告", "确定要删除吗？", function (button) {
									                        if (button == "yes") {
									                            var record = selModel.getSelections();
									                            for(var i=0;i<record.length;i++){
																                    var files=record[i].get("bfile");
																							      var reportdirs=record[i].get("reportdir");
																							      Ext.Ajax.request({
																							            url:'/msa/main.xp',
																							            method: "post",
																							            success: function (response, opts) {
																							               var resptxt=response.responseText;
																							             if(resptxt.substring(0,1)==1){
																							                 xtzygrid.store.load();
																							             }else{
																							                Ext.MessageBox.alert('提示','删除失败');
																							             }
																							            },
																							            failure: function () {
																							                Ext.Msg.alert('提示','删除失败');
																							            },
																							            params: {Fun:'msaReportJsonStore',
																							    								file:files,
																							    								reportdir:reportdirs
																													}
																							      });
																							}
																         	}
																      });
																  }else {
																      Ext.Msg.alert("错误", "没有任何行被选中，无法进行删除操作！");
																  }
							        }},'-']; 
         var userItems = this.items || []; 
         this.items = userItems.concat(pageSizeItems); 
         HlPagingToolbar.superclass.initComponent.call(this); 
    }, 
    onHlPagingKeyDown: function(field, e){ 
        if(field.isValid()){ 
             var k = e.getKey(); 
             if (k == e.RETURN) { 
                    e.stopEvent(); 
                    this.pageSize = field.getValue(); 
                    pagesize=this.pageSize;
                    this.doRefresh(); 
             } 
        } 
    }, 
    onHlPagingBlur: function(field){ 
        if(field.isValid()){ 
            this.pageSize = field.getValue(); 
            pagesize=this.pageSize;
            this.doRefresh(); 
        } 
    } 
   });
  
  var pagingBar= new HlPagingToolbar({
      store: xtzystore,
      pageSize: pagesize,
      displayInfo: true
  });

	var sm = new Ext.grid.CheckboxSelectionModel();
	var xtzygrid=new Ext.grid.GridPanel({
      store           :xtzystore,
      sm: sm,
      columns					:[
      			new Ext.grid.RowNumberer(),
        		sm,
      			{id:'reportname',header: "报告名称", width: 100, sortable: true, dataIndex: 'reportname'},
		        {header: "数据日期",   width: 100, sortable: true,  dataIndex: 'condition'},
	          {header: "报告状态",   width: 100, sortable: true,  dataIndex: 'reportstate'},
	          {header: "报告生成日期",   width: 120, sortable: true,  dataIndex: 'dates'},
	          {header: "报告日期",   width: 120, sortable: true,  dataIndex: 'bydate'}
      ],
      view: new Ext.grid.GroupingView({
      	hideGroupedColumn:true,
        forceFit:true,
        groupTextTpl: '{text} ({[values.rs.length]} {[values.rs.length > 1 ? "Items" : "Item"]})'
			}),
      tbar: pagingBar,
      stripeRows      :true,
      autoExpandColumn:'reportname',
      frame           :false,
	    collapsible     :false,
	    loadMask        :{msg:'正在加载数据，请稍侯……'},
	    draggable       :false
	});
	
	function showsysdelrule(btn){
			if(btn=='yes'){
				 var record = xtzygrid.getStore().getAt(detailEl);
		     var files=record.get("bfile");
		     var reportdirs=record.get("reportdir");
		   	 xtzystore.load({params:{Fun:'msaReportRecordJson',file:files,reportdir:reportdirs}});
		   	 xtzystore.load();
			}
	};
	
	var rightClick  = new Ext.menu.Menu({
		id:'feeds-ctx',
		items: [{
			id:'shanchubaogao',
			iconCls:'load-icon',
			text:'删除报告',
			scope: this,
			handler:function(){
				  Ext.MessageBox.confirm('Confirm', '您确认要删除吗?', showsysdelrule);
			}
		},{
			id:'liulanbaogao',
			iconCls:'load-icon',
			text:'浏览报告',
			scope: this,
			handler:function(){
				var record = xtzygrid.getStore().getAt(detailEl);
				var files=record.get("bfile");
				var reportdirs=record.get("reportdir");
				var usrl="/msadata/report/"+reportdirs+"/"+files+"/index.htm";
				var mywin =new  Ext.Window(
					{
						id: 'east-panel',
						title: '结果浏览',
						height: hgt,
						width: 400,
						closeAction: 'close',
						modal: 'true',
						maximizable:'true',
						margins:'0 5 0 0',
						html: "<IFRAME  name='resultfrm' width=100% height='"+(hgt-80)+"' SRC = '"+usrl+"'  border='0' frameborder='0' scrolling='yes' ></iframe>"
					});
					mywin.show();
					mywin.maximize();
				}
		},{
			id:'xiazaibaogao',
			iconCls:'load-icon',
			text:'下载报告',
			scope: this,
			handler:function(){
				var record = xtzygrid.getStore().getAt(detailEl);
				var files=record.get("bfile");
				var reportdirs=record.get("reportdir");
				var usrl="/msa/main.xp?Fun=msaDataCenetrDownLoad+downLoadFileName=report.tgz+downLoadFile=report/"+reportdirs+"/"+files+"/report.tgz";
				downloadFile(usrl);
			}
		},{
				id:'excel',
				iconCls:'load-icon',
				text:'下载Excel报告',
				scope: this,
				handler:function(){
					var record = xtzygrid.getStore().getAt(detailEl);
					var files=record.get("bfile");
					var reportdirs=record.get("reportdir");
					var usrl="/msa/main.xp?Fun=msaDataCenetrDownLoad+downLoadFileName=report.xls+downLoadFile=report/"+reportdirs+"/"+files+"/report.xls";
					downloadFile(usrl);
				}
			},{
				id:'datesource',
				iconCls:'load-icon',
				text:'下载原始数据',
				scope: this,
				handler:function(){
					var record = xtzygrid.getStore().getAt(detailEl);
					var files=record.get("bfile");
					var reportdirs=record.get("reportdir");
					var usrl="/msa/main.xp?Fun=msaDataCenetrDownLoad+downLoadFileName=source.xls+downLoadFile=report/"+reportdirs+"/"+files+"/source.xls";
					downloadFile(usrl);
				}
			}]
	});
				
	xtzygrid.addListener('rowcontextmenu', rightClickFn);
	function rightClickFn(client, rowIndex, e) {
		rightClick.showAt(e.getXY());
		detailEl=  rowIndex;
	}
	
		
		
    var mainPanel= {
			id: 'main-panel',
			region:'center',
			collapsible: false,
			split:true,
			minSize: 125,
			maxSize: 400,
			layout:'fit',
			margins:'0 0 0 0',
			items:[xtzygrid]
    }
	
    new Ext.Viewport({
		layout: 'border',
		items: [
			mainPanel
		],
		renderTo: Ext.getBody()
	});

	myMask.hide();
	
});
</script>

<meta name="GENERATOR" content="MSHTML 8.00.6001.18702"></head>
<body oncontextmenu="return false" style="SCROLLBAR-FACE-COLOR: #f0f0f0;  overflow-x:hidden;  OVERFLOW: scroll; SCROLLBAR-SHADOW-COLOR: #f0f0f0; SCROLLBAR-3DLIGHT-COLOR: #f0f0f0; SCROLLBAR-ARROW-COLOR: #f0f0f0; SCROLLBAR-DARKSHADOW-COLOR: #cccccc;" >
<div id="south" style="display: none;">  
    <fieldset style="width:300;height:30;border:2px groove" align=center>
    <legend>日期对象</legend>  
    <table width="100%" border="0" cellspacing="0" cellpadding="0" >        	
    	  <tr>
         <td  height="20"> 
        	<div align="left"> 
           开始日期&nbsp;&nbsp;:
            <input type="text"  class=inputf0 name="sdate"  id="sdate" size="25" maxlength="48" value="" onClick=setday(sdate)>
          </div>
        </td>
      </tr>      
        <tr>
         <td  height="20"> 
        	<div align="left"> 
           结束日期&nbsp;&nbsp;:
              <input type="text"  class=inputf0 name="edate" id="edate" size="25" maxlength="48" value="" onClick=setday(edate)>
          </div>
        </td>
      </tr>      
    </table>
    </fieldset>   
    <br><br>   
    <fieldset style="width:300;height:30;border:2px groove" align=center>
    <legend>汇总类型</legend>  
    <table width="100%" border="0" cellspacing="0" cellpadding="0" >        	
    	  <tr>
         <td  height="20"> 
        	<div align="left"> 
           选择类型&nbsp;&nbsp;:
           <select name="groupby"   class=inputself0 >
		          <option value="0" selected >按小时</option>
		          <option value="1" >按天</option>
		       </select>
          </div>
        </td>
      </tr>    
    </table>
    </fieldset>   
    <br>
  <br>
  <fieldset style="width:300;height:30;border:2px groove" align=center>
    <legend>名称</legend>
    <table width="100%" border="0" cellspacing="0" cellpadding="0" >
       <tr>
        <td  height="20"><div align="left"> 报告名称&nbsp;&nbsp;:
            <input type="text"  class=inputf0 name="rname"  id="rname" size="20" maxlength="48" value=""></div></td>
      </tr>
    </table>
  </fieldset>
  <br>
  <br>
</div>
</body>
</html>


